#!/bin/bash

set -e -u -x

function start_docker() {
  mkdir -p /var/log
  mkdir -p /var/run

  sanitize_cgroups

  # check for /proc/sys being mounted readonly, as systemd does
  if grep '/proc/sys\s\+\w\+\s\+ro,' /proc/mounts >/dev/null; then
    mount -o remount,rw /proc/sys
  fi

  local mtu=$(cat /sys/class/net/$(ip route get 8.8.8.8|awk '{ print $5 }')/mtu)
  local server_args="--mtu ${mtu}"

  dockerd --data-root /scratch/docker ${server_args} >/tmp/docker.log 2>&1 &
  echo $! > /tmp/docker.pid

  # trap stop_docker EXIT

  sleep 1

  until docker info >/dev/null 2>&1; do
    echo waiting for docker to come up...
    sleep 1
  done
}

start_docker

load_image=ubuntu-image

docker load -i "${load_image}/image"

docker tag \
  "$(cat "${load_image}/image-id")" \
  "$(cat "${load_image}/repository"):$(cat "${load_image}/tag")"

pushd concourse-image-build-root
  docker build -t image-rc .
popd

docker save -o concourse-image/image image-rc
